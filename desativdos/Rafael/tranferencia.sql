select ROTA, nr_viagem , vlr , (custo + (nr_viagem * vl_pedagio)) / peso ind_real, 1-(peso_md/peso_padrao) ocios , ((peso_padrao*nr_viagem) - peso) ocios_kg,  frete , peso , frete/ peso pmv, (custo + (nr_viagem * vl_pedagio)) custo  	                                , (custo + (nr_viagem * vl_pedagio))/(case when frete = 0 then 1 else frete end) p_custo , (((peso_md - peso_padrao) * vlr) + ((((custo + (nr_viagem * vl_pedagio)) / peso) - vlr)  * peso)) perda, peso_md, peso_padrao, faturamento.fat                                 from (                                 select dados.ESTADO_ORIGEM + dados.ESTADO_DESTINO ROTA, COUNT(NUM_CONTRATO) + ISNULL(total_ret,0) nr_viagem ,  isnull(vlr.indice,0)  vlr 	                                , sum((case when desc_tipo = 'TRANSFERENCIA' then frete.frete else 0.01 end))   frete , isnull(vlr.valor_pedagio,0) vl_pedagio 	                                , sum((case when desc_tipo = 'TRANSFERENCIA' then frete.peso else 0.01 end))  peso,  isnull(vlr.peso_padrao,22000)   peso_padrao , sum(frete.peso)/ (COUNT(NUM_CONTRATO) + ISNULL(total_ret,0))  peso_md 	                                ,  sum(dados.CUSTO ) + ISNULL(CUSTO_ret,0)  custo  	                                 , 0 p_custo , 0 perda , desc_tipo 	                                    from ( 		                                select  NUM_CONTRATO , FIL_CONTRATO , ESTADO_ORIGEM, ESTADO_DESTINO , cast(DT_EMIS_CONTRATO as date) dt_cont, sum(VALOR_CONTRATO) CUSTO , 'TRANSFERENCIA' desc_tipo 		                                from tb_valores_contrato_custo 		                                where TIPO_CONTRATO = 'TRANSFERENCIA' and DESCR_TIPO_PAGTO <> 'RETORNO VAZIO' and ESTADO_ORIGEM <> ESTADO_DESTINO and DEB_CRED_TIPO_PAGTO = 'C' 		                                and cast(DT_EMIS_CONTRATO as date) between  cast(dateadd(DD,DAY(GETDATE())*(-1)+1,getdate()) as date)  and cast(  getdate()  as date)                                   group by  NUM_CONTRATO , FIL_CONTRATO , ESTADO_ORIGEM, ESTADO_DESTINO, DT_EMIS_CONTRATO                                                                      )dados                                      outer apply ( 					                                    Select count(NUM_CONTRATO) total_ret , Sum(VALOR_CONTRATO) CUSTO_ret  					                                    From Tb_valores_contrato_custo  					                                    Where TIPO_CONTRATO = 'TRANSFERENCIA' And DESCR_TIPO_PAGTO = 'RETORNO VAZIO'  and DEB_CRED_TIPO_PAGTO = 'C' 					                                    And Cast(DT_EMIS_CONTRATO As Date) between  cast(dateadd(DD,DAY(GETDATE())*(-1)+1,getdate()) as date)  and cast(  getdate()  as date)                                                  and ESTADO_DESTINO = Dados.ESTADO_ORIGEM and ESTADO_ORIGEM = Dados.ESTADO_DESTINO 					                                    ) total_retorno 					                                 outer apply ( 		                                select sum(nr_peso_rel) peso, sum(FRETE ) frete 		                                from tb_dados_manifesto_custo_emis dmc 		                                inner join tb_dados_movimento_custo_emis con on con.NR_ENTRADA = dmc.NR_ENTRADA and con.SIGLA_FIL = dmc.SIGLA_FIL 		                                where NUM_CONTRATO = dados.NUM_CONTRATO	and FIL_CONTRATO = dados.FIL_CONTRATO  			                                ) frete                                 outer apply ( select top 1 indice, peso_padrao, valor_pedagio from tb_vlr_transferencia where ds_ori =  dados.ESTADO_ORIGEM and ds_dest =  dados.ESTADO_DESTINO and dados.dt_cont between dt_ini_val and dt_fim_val order by id_vlr desc) vlr                                 Group By Dados.ESTADO_ORIGEM , Dados.ESTADO_DESTINO , Vlr.Indice, vlr.valor_pedagio, Peso_padrao, Dados.Desc_tipo , CUSTO_ret , total_ret                                 ) tb                                                                                                      outer apply( select  SUM(FRETE) fat from tb_dados_movimento_custo_emis where CAST( DT_EMISSAO as date) between  cast(dateadd(DD,DAY(GETDATE())*(-1)+1,getdate()) as date)  and cast(  getdate()  as date)  ) faturamento